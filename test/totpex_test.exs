defmodule TotpexTest do
  use ExUnit.Case

  # RFCs
  # ====
  #  - HOTP, 4226: https://tools.ietf.org/html/rfc4226
  #  - TOTP, 6238: https://tools.ietf.org/html/rfc6238

  setup do
    %{
      test_vectors: [
        # { unix_timestamp, date_string, expected_token, hash_alg }
        {59, "1970-01-01 00:00:59", "287082", :sha},
        {59, "1970-01-01 00:00:59", "119246", :sha256},
        {59, "1970-01-01 00:00:59", "693936", :sha512},
        {59, "1970-01-01 00:00:59", "94287082", :sha},
        {59, "1970-01-01 00:00:59", "46119246", :sha256},
        {59, "1970-01-01 00:00:59", "90693936", :sha512},

        {1111111109, "2005-03-18 01:58:29", "081804", :sha},
        {1111111109, "2005-03-18 01:58:29", "084774", :sha256},
        {1111111109, "2005-03-18 01:58:29", "091201", :sha512},
        {1111111109, "2005-03-18 01:58:29", "07081804", :sha},
        {1111111109, "2005-03-18 01:58:29", "68084774", :sha256},
        {1111111109, "2005-03-18 01:58:29", "25091201", :sha512},

        {1111111111, "2005-03-18 01:58:31", "050471", :sha},
        {1111111111, "2005-03-18 01:58:31", "062674", :sha256},
        {1111111111, "2005-03-18 01:58:31", "943326", :sha512},
        {1111111111, "2005-03-18 01:58:31", "14050471", :sha},
        {1111111111, "2005-03-18 01:58:31", "67062674", :sha256},
        {1111111111, "2005-03-18 01:58:31", "99943326", :sha512},

      ]
    }
  end

  # Test vectors: https://tools.ietf.org/html/rfc6238#page-14
  # +-------------+--------------+------------------+----------+--------+
  # |  Time (sec) |   UTC Time   | Value of T (hex) |   TOTP   |  Mode  |
  # +-------------+--------------+------------------+----------+--------+
  # |      59     |  1970-01-01  | 0000000000000001 | 94287082 |  SHA1  |
  # |             |   00:00:59   |                  |          |        |
  # |      59     |  1970-01-01  | 0000000000000001 | 46119246 | SHA256 |
  # |             |   00:00:59   |                  |          |        |
  # |      59     |  1970-01-01  | 0000000000000001 | 90693936 | SHA512 |
  # |             |   00:00:59   |                  |          |        |
  # |  1111111109 |  2005-03-18  | 00000000023523EC | 07081804 |  SHA1  |
  # |             |   01:58:29   |                  |          |        |
  # |  1111111109 |  2005-03-18  | 00000000023523EC | 68084774 | SHA256 |
  # |             |   01:58:29   |                  |          |        |
  # |  1111111109 |  2005-03-18  | 00000000023523EC | 25091201 | SHA512 |
  # |             |   01:58:29   |                  |          |        |
  # |  1111111111 |  2005-03-18  | 00000000023523ED | 14050471 |  SHA1  |
  # |             |   01:58:31   |                  |          |        |
  # |  1111111111 |  2005-03-18  | 00000000023523ED | 67062674 | SHA256 |
  # |             |   01:58:31   |                  |          |        |
  # |  1111111111 |  2005-03-18  | 00000000023523ED | 99943326 | SHA512 |
  # |             |   01:58:31   |                  |          |        |
  # |  1234567890 |  2009-02-13  | 000000000273EF07 | 89005924 |  SHA1  |
  # |             |   23:31:30   |                  |          |        |
  # |  1234567890 |  2009-02-13  | 000000000273EF07 | 91819424 | SHA256 |
  # |             |   23:31:30   |                  |          |        |
  # |  1234567890 |  2009-02-13  | 000000000273EF07 | 93441116 | SHA512 |
  # |             |   23:31:30   |                  |          |        |
  # |  2000000000 |  2033-05-18  | 0000000003F940AA | 69279037 |  SHA1  |
  # |             |   03:33:20   |                  |          |        |
  # |  2000000000 |  2033-05-18  | 0000000003F940AA | 90698825 | SHA256 |
  # |             |   03:33:20   |                  |          |        |
  # |  2000000000 |  2033-05-18  | 0000000003F940AA | 38618901 | SHA512 |
  # |             |   03:33:20   |                  |          |        |
  # | 20000000000 |  2603-10-11  | 0000000027BC86AA | 65353130 |  SHA1  |
  # |             |   11:33:20   |                  |          |        |
  # | 20000000000 |  2603-10-11  | 0000000027BC86AA | 77737706 | SHA256 |
  # |             |   11:33:20   |                  |          |        |
  # | 20000000000 |  2603-10-11  | 0000000027BC86AA | 47863826 | SHA512 |
  # |             |   11:33:20   |                  |          |        |
  # +-------------+--------------+------------------+----------+--------+
  #
  test "Rfc test vectors test" do
    rawkey = "12345678901234567890"
    secret = Base.encode32(rawkey)
    assert "94287082" == Totpex.generate_totp(secret, 59, length: 8)
    assert "07081804" == Totpex.generate_totp(secret, 1111111109, length: 8)
    assert "14050471" == Totpex.generate_totp(secret, 1111111111, length: 8)
    assert "89005924" == Totpex.generate_totp(secret, 1234567890, length: 8)
    assert "69279037" == Totpex.generate_totp(secret, 2000000000, length: 8)
    assert "65353130" == Totpex.generate_totp(secret, 20000000000, length: 8)
  end
end
